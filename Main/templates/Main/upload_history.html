{% extends "Main/base.html" %}
{% load static %}

{% block title %}Histórico de Uploads | Grupo Rivema{% endblock %}

{% block content %}

<div class="page-header">
  <h1>Histórico de Uploads</h1>
  <p class="subtitle">Acompanhamento dos arquivos importados no sistema</p>
</div>

<div class="card">

  {% if page_obj %}
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid var(--primary);">
            <th>Data/Hora</th>
            <th>Tipo</th>
            <th>Arquivo</th>
            <th>Usuário</th>
            <th>Status</th>
            <th>Registros</th>
            <th>Lote</th>
          </tr>
        </thead>

        <tbody>
          {% for upload in page_obj %}
          <tr style="border-bottom:1px solid var(--border);">
            <td>{{ upload.uploaded_at|date:"d/m/Y H:i" }}</td>

            <td>{{ upload.get_file_type_display }}</td>

            <td>
              <a href="{{ upload.file.url }}" target="_blank" style="color:var(--primary);font-weight:600;">
                {{ upload.file.name|slice:"8:" }}
              </a>
            </td>

            <td>
              {% if upload.uploaded_by %}
                {{ upload.uploaded_by.username }}
              {% else %}
                —
              {% endif %}
            </td>

            <td>
              {% if upload.status == "COMPLETED" %}
                <span style="background:#DCFCE7;color:#166534;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  Concluído
                </span>
              {% elif upload.status == "PROCESSING" %}
                <span style="background:#FEF3C7;color:#92400E;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  Processando
                </span>
              {% elif upload.status == "FAILED" %}
                <span style="background:#FEE2E2;color:#991B1B;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  Erro
                </span>
              {% else %}
                <span style="background:#E5E7EB;color:#374151;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  —
                </span>
              {% endif %}
            </td>

            <td>
              {{ upload.processed_records }}/{{ upload.total_records }}
            </td>

            <td>
              {% if upload.batch %}
                <a href="{% url 'Main:product_list' %}?batch={{ upload.batch.batch_code }}"
                   style="color:var(--primary);font-weight:600;">
                  {{ upload.batch.batch_code }}
                </a>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>

          {% if upload.error_message %}
          <tr>
            <td colspan="7" style="background:#FEE2E2;color:#991B1B;padding:12px;font-size:14px;">
              <strong>Erro:</strong> {{ upload.error_message }}
            </td>
          </tr>
          {% endif %}

          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINAÇÃO -->
    <div style="margin-top:25px;display:flex;justify-content:space-between;align-items:center;">
      <span class="subtitle">
        Mostrando {{ page_obj.start_index }} – {{ page_obj.end_index }}
        de {{ page_obj.paginator.count }} uploads
      </span>

      <div style="display:flex;gap:10px;">
        {% if page_obj.has_previous %}
          <a class="btn-secondary" href="?page=1">Primeira</a>
          <a class="btn-secondary" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}

        <span class="btn-primary">{{ page_obj.number }}</span>

        {% if page_obj.has_next %}
          <a class="btn-secondary" href="?page={{ page_obj.next_page_number }}">Próxima</a>
          <a class="btn-secondary" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
        {% endif %}
      </div>
    </div>

  {% else %}
    <p class="subtitle" style="text-align:center;margin-top:40px;">
      Nenhum upload encontrado.
    </p>
  {% endif %}

</div>

{% endblock %}
