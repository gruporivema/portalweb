{% extends "Main/base.html" %}
{% load static %}

{% block title %}Produtos | Grupo Rivema{% endblock %}

{% block content %}

<div class="page-header">
  <h1>Produtos Cadastrados</h1>
  <p class="subtitle">Consulta e acompanhamento dos produtos importados</p>
</div>

<div class="card">

  <!-- FILTROS -->
  <form method="get" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 30px;">
    
    <div>
      <label>Buscar</label>
      <input
        type="text"
        name="search"
        value="{{ search_query }}"
        placeholder="Código, descrição, fornecedor..."
      />
    </div>

    <div>
      <label>Lote</label>
      <select name="batch">
        <option value="">Todos</option>
        {% for batch in batches %}
          <option value="{{ batch.batch_code }}" {% if batch_filter == batch.batch_code %}selected{% endif %}>
            {{ batch.batch_code }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Status</label>
      <select name="sync">
        <option value="">Todos</option>
        <option value="synced" {% if sync_filter == "synced" %}selected{% endif %}>Sincronizados</option>
        <option value="pending" {% if sync_filter == "pending" %}selected{% endif %}>Pendentes</option>
      </select>
    </div>

    <button type="submit" class="btn-primary">Filtrar</button>
  </form>

  <!-- TABELA -->
  {% if page_obj %}
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid var(--primary);">
            <th>Código</th>
            <th>Descrição</th>
            <th>Preço</th>
            <th>Estoque</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>

        <tbody>
          {% for product in page_obj %}
          <tr style="border-bottom: 1px solid var(--border);">
            <td>{{ product.product_code }}</td>
            <td>{{ product.description|truncatewords:8 }}</td>
            <td>
              {% if product.sale_price %}
                R$ {{ product.sale_price }}
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ product.current_stock }}</td>
            <td>
              {% if product.synced_to_protheus %}
                <span style="background:#DCFCE7;color:#166534;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  Sincronizado
                </span>
              {% else %}
                <span style="background:#FEF3C7;color:#92400E;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;">
                  Pendente
                </span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'Main:product_detail' product.pk %}" style="color:var(--primary);font-weight:600;">
                Ver detalhes
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINAÇÃO -->
    <div style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center;">
      <span class="subtitle">
        Mostrando {{ page_obj.start_index }} – {{ page_obj.end_index }}
        de {{ page_obj.paginator.count }}
      </span>

      <div style="display:flex;gap:10px;">
        {% if page_obj.has_previous %}
          <a class="btn-secondary" href="?page=1">Primeira</a>
          <a class="btn-secondary" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}

        <span class="btn-primary">{{ page_obj.number }}</span>

        {% if page_obj.has_next %}
          <a class="btn-secondary" href="?page={{ page_obj.next_page_number }}">Próxima</a>
          <a class="btn-secondary" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
        {% endif %}
      </div>
    </div>

  {% else %}
    <p class="subtitle" style="text-align:center;margin-top:40px;">
      Nenhum produto encontrado.
    </p>
  {% endif %}
</div>

{% endblock %}
