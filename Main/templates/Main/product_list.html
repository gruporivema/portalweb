{% extends "base.html" %}
{% load static %}

{% block title %}Produtos | Grupo Rivema{% endblock %}

{% block content %}

<div class="page-header">
  <h1>Produtos Cadastrados</h1>
  <p class="subtitle">Consulta e acompanhamento dos produtos importados</p>
</div>

<div class="card">
  <form method="get" class="filters">
    <div>
      <label>Buscar</label>
      <input
        type="text"
        name="search"
        value="{{ search_query }}"
        placeholder="Código, descrição, fornecedor..."
      />
    </div>

    <div>
      <label>Lote</label>
      <select name="batch">
        <option value="">Todos</option>
        {% for batch in batches %}
          <option value="{{ batch.batch_code }}"
            {% if batch_filter == batch.batch_code %}selected{% endif %}>
            {{ batch.batch_code }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Status</label>
      <select name="sync">
        <option value="">Todos</option>
        <option value="synced" {% if sync_filter == 'synced' %}selected{% endif %}>
          Sincronizados
        </option>
        <option value="pending" {% if sync_filter == 'pending' %}selected{% endif %}>
          Pendentes
        </option>
      </select>
    </div>

    <button type="submit" class="btn-primary">Filtrar</button>
  </form>
</div>

<div class="card">
  {% if page_obj %}
    <table>
      <thead>
        <tr>
          <th>Código</th>
          <th>Descrição</th>
          <th>Preço</th>
          <th>Estoque</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for product in page_obj %}
          <tr>
            <td>{{ product.product_code }}</td>
            <td>{{ product.description|truncatewords:8 }}</td>
            <td>
              {% if product.sale_price %}
                R$ {{ product.sale_price }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ product.current_stock }}</td>
            <td>
              {% if product.synced_to_protheus %}
                <span class="badge badge-success">Sincronizado</span>
              {% else %}
                <span class="badge badge-warning">Pendente</span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'Main:product_detail' product.pk %}"
                 style="color: var(--primary); font-weight: 600;">
                Ver detalhes
              </a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pagination">
      <div>
        Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }}
        de {{ page_obj.paginator.count }} produtos
      </div>

      <div>
        {% if page_obj.has_previous %}
          <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if batch_filter %}&batch={{ batch_filter }}{% endif %}{% if sync_filter %}&sync={{ sync_filter }}{% endif %}">
            Primeira
          </a>
          <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if batch_filter %}&batch={{ batch_filter }}{% endif %}{% if sync_filter %}&sync={{ sync_filter }}{% endif %}">
            Anterior
          </a>
        {% endif %}

        <span class="active">{{ page_obj.number }}</span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if batch_filter %}&batch={{ batch_filter }}{% endif %}{% if sync_filter %}&sync={{ sync_filter }}{% endif %}">
            Próxima
          </a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if batch_filter %}&batch={{ batch_filter }}{% endif %}{% if sync_filter %}&sync={{ sync_filter }}{% endif %}">
            Última
          </a>
        {% endif %}
      </div>
    </div>

  {% else %}
    <p>Nenhum produto encontrado.</p>
  {% endif %}
</div>

{% endblock %}
