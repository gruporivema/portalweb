{% extends 'Main/base.html' %}
{% load static %}

{% block title %}Valida√ß√£o de Produtos{% endblock %}

{% block description %}Valide os produtos importados antes de enviar ao Protheus - Portal Web Grupo Rivema{% endblock %}

{% block extra_css %}
<style>
  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--white);
    color: var(--primary);
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
    margin-bottom: 30px;
  }

  .back-button:hover {
    border-color: var(--primary);
    background: rgba(11, 110, 60, 0.05);
    transform: translateX(-4px);
  }

  .info-card {
    background: linear-gradient(135deg, var(--white) 0%, #FAFBFA 100%);
    padding: 25px 30px;
    border-radius: 12px;
    margin-bottom: 25px;
    border-left: 4px solid var(--primary);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .info-card-content p {
    margin: 0;
    font-weight: 500;
  }

  .info-card-content p:first-child {
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 16px;
  }

  .info-card-content p:last-child {
    color: var(--muted);
    font-size: 14px;
    margin-top: 5px;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn-validate {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: var(--white);
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
  }

  .btn-validate:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  }

  .btn-validate:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-submit {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: var(--white);
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(11, 110, 60, 0.3);
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(11, 110, 60, 0.4);
  }

  .table-wrapper {
    background: var(--white);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    overflow-x: auto;
    margin-bottom: 30px;
  }

  .validation-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1200px;
  }

  .validation-table thead tr {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  }

  .validation-table th {
    padding: 18px 16px;
    text-align: left;
    color: var(--white);
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .validation-table th:nth-child(2),
  .validation-table th:nth-child(3),
  .validation-table th:nth-child(4),
  .validation-table th:nth-child(5),
  .validation-table th:nth-child(6),
  .validation-table th:nth-child(7) {
    text-align: right;
  }

  .validation-table th:nth-child(8) {
    text-align: center;
  }

  .validation-table tbody tr {
    border-bottom: 1px solid var(--border);
    transition: all 0.2s ease;
  }

  .validation-table tbody tr.row-valid {
    background: linear-gradient(135deg, #DCFCE7 0%, #F0FDF4 100%);
  }

  .validation-table tbody tr.row-invalid {
    background: linear-gradient(135deg, #FEE2E2 0%, #FEF2F2 100%);
  }

  .validation-table tbody tr.row-pending {
    background: linear-gradient(135deg, #FEF3C7 0%, #FEFCE8 100%);
  }

  .validation-table tbody tr:hover {
    transform: scale(1.002);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .validation-table td {
    padding: 16px;
    color: var(--text);
    font-size: 14px;
  }

  .validation-table td:nth-child(2),
  .validation-table td:nth-child(3),
  .validation-table td:nth-child(4),
  .validation-table td:nth-child(5),
  .validation-table td:nth-child(6),
  .validation-table td:nth-child(7) {
    text-align: right;
  }

  .validation-table td:nth-child(8) {
    text-align: center;
  }

  .validation-table td:first-child {
    font-weight: 600;
  }

  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .status-valid {
    background: #16A34A;
    color: var(--white);
  }

  .status-invalid {
    background: #DC2626;
    color: var(--white);
  }

  .status-pending {
    background: #F59E0B;
    color: var(--white);
  }

  .error-text {
    color: #991B1B;
    font-size: 13px;
  }

  .legend-card {
    background: var(--white);
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  }

  .legend-card p {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 15px;
  }

  .legend-items {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .legend-color {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    flex-shrink: 0;
  }

  .legend-color.valid {
    background: linear-gradient(135deg, #DCFCE7 0%, #D1FAE5 100%);
  }

  .legend-color.invalid {
    background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
  }

  .legend-color.pending {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
  }

  .legend-item span {
    color: var(--muted);
    font-size: 14px;
  }

  .empty-state {
    padding: 80px 40px;
    text-align: center;
    color: var(--muted);
  }

  .empty-state h3 {
    font-size: 24px;
    margin-bottom: 10px;
    color: var(--text);
  }

  @media (max-width: 768px) {
    .info-card {
      flex-direction: column;
      align-items: flex-start;
    }

    .action-buttons {
      width: 100%;
      flex-direction: column;
    }

    .btn-validate,
    .btn-submit {
      width: 100%;
      text-align: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'Main:filter_selection' batch.batch_code %}" class="back-button">
  ‚Üê Voltar
</a>

<div class="page-header">
  <h1 class="page-title">Valida√ß√£o de Produtos - Pedido de Compra</h1>
  <p class="page-subtitle">Valide os produtos importados antes de enviar ao Protheus</p>
</div>

<div class="info-card">
  <div class="info-card-content">
    <p>Lote: {{ batch.batch_code }}</p>
    <p>Fornecedor: {{ fornecedor_code }}</p>
  </div>
  <div class="action-buttons">
    <button id="validateBtn" onclick="validateAllCodes()" class="btn-validate">
      ‚úì Validar C√≥digos
    </button>
    <a href="{% url 'Main:submit_to_protheus' batch.batch_code %}" class="btn-submit">
      ‚Üí Submeter ao Protheus
    </a>
  </div>
</div>

<div class="table-wrapper">
  {% if products %}
    <table class="validation-table">
      <thead>
        <tr>
          <th>C√≥d "Bruto"</th>
          <th>Quant.</th>
          <th>Valor Unit.</th>
          <th>Desconto</th>
          <th>Base Calc ICMS</th>
          <th>Aliq IPI</th>
          <th>Aliq ICMS</th>
          <th>Status</th>
          <th>Erro</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr class="{% if product.validation_status == 'VALID' %}row-valid{% elif product.validation_status == 'INVALID' %}row-invalid{% else %}row-pending{% endif %}"
            data-product-id="{{ product.id }}">
          <td>{{ product.product_code }}</td>
          <td>{{ product.quantity|default:"-" }}</td>
          <td>{% if product.unit_value %}R$ {{ product.unit_value }}{% else %}-{% endif %}</td>
          <td>{% if product.discount %}R$ {{ product.discount }}{% else %}-{% endif %}</td>
          <td>{% if product.icms_base %}R$ {{ product.icms_base }}{% else %}-{% endif %}</td>
          <td>{% if product.ipi_percentage %}{{ product.ipi_percentage }}%{% else %}-{% endif %}</td>
          <td>{% if product.icms_percentage %}{{ product.icms_percentage }}%{% else %}-{% endif %}</td>
          <td>
            {% if product.validation_status == 'VALID' %}
              <span class="status-badge status-valid">‚úì Validado</span>
            {% elif product.validation_status == 'INVALID' %}
              <span class="status-badge status-invalid">‚úó Inv√°lido</span>
            {% else %}
              <span class="status-badge status-pending">‚è≥ Pendente</span>
            {% endif %}
          </td>
          <td class="error-text">{{ product.validation_error|default:"-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="empty-state">
      <h3>üì¶ Nenhum produto encontrado</h3>
      <p>Verifique o lote selecionado.</p>
    </div>
  {% endif %}
</div>

<div class="legend-card">
  <p>üìã Legenda:</p>
  <div class="legend-items">
    <div class="legend-item">
      <div class="legend-color valid"></div>
      <span>Validado (C√≥digo existe no Protheus)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color invalid"></div>
      <span>Inv√°lido (C√≥digo n√£o existe ou erro)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color pending"></div>
      <span>Pendente (Aguardando valida√ß√£o)</span>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function validateAllCodes() {
    const validateBtn = document.getElementById('validateBtn');
    validateBtn.disabled = true;
    validateBtn.textContent = 'Validando...';

    const productIds = [];
    document.querySelectorAll('[data-product-id]').forEach(row => {
      productIds.push(row.getAttribute('data-product-id'));
    });

    const formData = new FormData();
    productIds.forEach(id => {
      formData.append('product_ids[]', id);
    });

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ?
                     document.querySelector('[name=csrfmiddlewaretoken]').value :
                     getCookie('csrftoken');

    fetch('{% url "Main:validate_codes" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Erro ao validar c√≥digos. Tente novamente.');
        validateBtn.disabled = false;
        validateBtn.textContent = '‚úì Validar C√≥digos';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erro ao validar c√≥digos. Tente novamente.');
      validateBtn.disabled = false;
      validateBtn.textContent = '‚úì Validar C√≥digos';
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}